#!/bin/bash

#----------------------------------------------------------------------------------
# Project Name      - bdl
# Started On        - Sat 16 Sep 22:34:12 BST 2017
# Last Change       - Thu  5 Oct 18:10:11 BST 2017
# Author E-Mail     - terminalforlife@yahoo.com
# Author GitHub     - https://github.com/terminalforlife
#----------------------------------------------------------------------------------

XERR(){ echo "[L${1}] ERROR: $2" 1>&2; exit 1; }
ERR(){ echo "[L${1}] ERROR: $2" 1>&2; }

DEPCOUNT=0
for DEP in /usr/bin/{wc,find,wget,head} /bin/{sync,mkdir,uname} /sbin/shutdown; {
	[ -x "$DEP" ] || {
		ERR "$LINENO" "Dependency '$DEP' not met."
		let DEPCOUNT++
	}
}

[ $DEPCOUNT -gt 0 ] && exit 1

DL_DIR="./"
MAIN_DIR="$HOME/.bdl"
LIST_EDITOR_FILE="$MAIN_DIR/editor.conf"
BDL_FILE="$MAIN_DIR/bdl_list.txt"

SHUTDOWN="false"
VERBOSE="false"
NOTIFY="false"
DEBUG="false"

/bin/mkdir -p "$MAIN_DIR"
[ -f "$BDL_FILE" ] || > "$BDL_FILE"

USAGE(){
	while read -r; do
		echo "$REPLY"
	done <<-EOF
		            BDL - Batch Downloader (5th October 2017)
		            Written by terminalforlife (terminalforlife@yahoo.com)
		
		            Easily and quickly download a batch of files using wget.
		
		OPTS:       --help|-h|-?            - Displays this help information.
		            --debug|-d              - Enables the built-in bash debugging.
		            --tohere=T              - Where T is the location to download.
		            --editor=E              - Where E is the command for your editor.
		            --verbose|-v            - Display wget's more verbose output.
		            --suspend|-s            - Immediately suspend machine when finished.
		            --shutdown|-S           - Like above, but a shutdown after 1 minute.
		            --notify|-N             - Use notify-send to inform of bdl completion.
		                                      Notifies only after all files are finished.
		            --edit|-e               - Change URL list with an available text editor.
		            --empty|-C              - Empty the bdl download list entirely.
		
		FILE:       All files are found in '\$HOME/.bdl'.
	EOF
}

if ! [ -f "$LIST_EDITOR_FILE" ]\
&& ! [ -w "$LIST_EDITOR_FILE" ]\
&& ! [ -s "$LIST_EDITOR_FILE" ]; then
	XERR "$LINENO" "Please choose an editor. See --help for info."
else
	LIST_EDITOR=`< "$LIST_EDITOR_FILE"`
fi

INIT_MAIN(){
	[ "$DEBUG" == "true" ] && set -xue

	case "$VERBOSE" in
		false)
			VFLAG="--quiet" ;;
		true)
			VFLAG="-v" ;;
	esac

	echo -e "[ `printf '%(%F %X)T\n'` ] Lines detected in bdl"\
		"list: $(/usr/bin/wc -l < "$BDL_FILE")\n"

	for LINK in `< "$BDL_FILE"`; {
		/usr/bin/wget --random-wait --continue --tries=1 $VFLAG --max-redirect=1\
			--show-progress "$LINK" -O "${DL_DIR}/${LINK/*\//}"

		/bin/sync "${DL_DIR}/${LINK/*\//}"
	}

	[ "$NOTIFY" == "true" ] && {
		if type -P /usr/bin/notify-send &> /dev/null; then
			/usr/bin/notify-send "Downloading with bdl is completed."
		else
			ERR "$LINENO" "Unable to find notify-send."
		fi
	}

	[ "$DEBUG" == "true" ] && set +xue

	if [ "$SHUTDOWN" == "true" ]; then
		/sbin/shutdown --no-wall +1
		/usr/bin/notify-send "System shutdown in one minute." -i warning -u critical
	elif [ "$SUSPEND" == "true" ]; then
		if [ -x /bin/systemctl ]; then
			/usr/bin/notify-send "System will suspend." -i warning -u critical
			/bin/systemctl suspend
		elif [ -x /usr/sbin/pm-suspend ]; then
			/usr/bin/notify-send "System will suspend." -i warning -u critical
			/usr/sbin/pm-suspend
		else
			XERR "$LINENO" "Failed to suspend the machine."
		fi
	fi
}

EDIT(){
	if [ -x "$LIST_EDITOR" ]; then
		$LIST_EDITOR "$BDL_FILE" 2> /dev/null
		exit 0
	else
		XERR "$LINENO" "Unable to execute: $LIST_EDITOR"
	fi
}

EMPTY(){
	/bin/cp "$BDL_FILE" "${BDL_FILE}.old" &> /dev/null
	echo "NOTE: File '$BDL_FILE' was backed up." > "$BDL_FILE"
	echo "      File '$BDL_FILE' now completely empty."
}

for ARG; {
	case ${ARG:-EMPTY} in
		--help|-h|-\?)
			USAGE; exit 0 ;;
		--debug|-d)
			DEBUG="true" ;;
		--tohere=*)
			DL_DIR="${ARG/*=}"

			[ -d "$TOHERE" ] || {
				XERR "$LINENO" "Destination directory unavailable."
			} ;;
		--editor=*)
			echo "${ARG/*=}" > "$LIST_EDITOR_FILE"; exit 0 ;;
		--edit|-e)
			EDIT ;;
		--empty|-E)
			EMPTY; exit 0 ;;
		--verbose|-v)
			VERBOSE="true" ;;
		--notify|-N)
			NOTIFY="true" ;;
		--suspend|-s)
			SUSPEND="true" ;;
		--shutdown|-S)
			SHUTDOWN="true" ;;
		EMPTY)
			;;
		*)
			XERR "$LINENO" "Incorrect argument(s)." ;;
	esac
}

[ `/bin/uname -s` == "Linux" ] || XERR "$LINENO" "Unsupported platform."
[ $UID -eq 0 ] && XERR "$LINENO" "Root access is not required."

case "$SHUTDOWN" in
	false)
		INIT_MAIN ;;
	true)
		INIT_MAIN SHUTDOWN ;;
esac
